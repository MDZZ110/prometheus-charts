{{- /*
Generated from 'thanos-rule' group from https://raw.githubusercontent.com/WhizardTelemetry/kse-prometheus/kse/manifests/thanos-ruler/thanos-ruler-alertRuleGroups.yaml
Do not change in-place! In order to change this file first read following link:
https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack/hack
*/ -}}
{{- $kubeTargetVersion := default .Capabilities.KubeVersion.GitVersion .Values.kubeTargetVersionOverride }}
{{- if and (semverCompare ">=1.14.0-0" $kubeTargetVersion) (semverCompare "<9.9.9-9" $kubeTargetVersion) .Values.defaultRules.create }}
{{- $namespace := printf "%s" (include "kube-prometheus-stack.namespace" .) }}
apiVersion: alerting.kubesphere.io/v2beta1
kind: GlobalRuleGroup
metadata:
  name: {{ printf "%s-%s" (include "kube-prometheus-stack.fullname" .) "thanos-rule" | trunc 63 | trimSuffix "-" }}
  labels:
    app: {{ template "kube-prometheus-stack.name" . }}
    alerting.kubesphere.io/builtin: "true"
    alerting.kubesphere.io/enable: "true"
{{- include "kube-prometheus-stack.labels" . | indent 4 }}
{{- if .Values.defaultRules.labels }}
{{ toYaml .Values.defaultRules.labels | indent 4 }}
{{- end }}
{{- if .Values.defaultRules.annotations }}
  annotations:
{{ toYaml .Values.defaultRules.annotations | indent 4 }}
{{- end }}
spec:
  rules:
  - alert: ThanosRuleQueueIsDroppingAlerts
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} is failing to queue alerts.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulequeueisdroppingalerts
      summary: Thanos Rule is failing to queue alerts.
    expr: sum by (cluster, namespace, job, instance) (rate(thanos_alert_queue_alerts_dropped_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m])) > 0
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 8a663511d4642025f5a0580fd618d89b
    severity: critical
  - alert: ThanosRuleSenderIsFailingAlerts
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} is failing to send alerts to alertmanager.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulesenderisfailingalerts
      summary: Thanos Rule is failing to send alerts to alertmanager.
    expr: sum by (cluster, namespace, job, instance) (rate(thanos_alert_sender_alerts_dropped_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m])) > 0
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 7e994d7a9912689118fe68327d516d74
    severity: critical
  - alert: ThanosRuleHighRuleEvaluationFailures
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} is failing to evaluate rules.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulehighruleevaluationfailures
      summary: Thanos Rule is failing to evaluate rules.
    expr: |-
      (
        sum by (cluster, namespace, job, instance) (rate(prometheus_rule_evaluation_failures_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      /
        sum by (cluster, namespace, job, instance) (rate(prometheus_rule_evaluations_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      * 100 > 5
      )
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 1369506100b9d16e1ee4c5369b07eb4d
    severity: critical
  - alert: ThanosRuleHighRuleEvaluationWarnings
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has high number of evaluation warnings.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulehighruleevaluationwarnings
      summary: Thanos Rule has high number of evaluation warnings.
    expr: sum by (cluster, namespace, job, instance) (rate(thanos_rule_evaluation_with_warnings_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m])) > 0
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: e86609a38691ffe545d2a8da6743dfab
    severity: info
  - alert: ThanosRuleRuleEvaluationLatencyHigh
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has higher evaluation latency than interval for {{`{{`}}$labels.rule_group{{`}}`}}.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosruleruleevaluationlatencyhigh
      summary: Thanos Rule has high rule evaluation latency.
    expr: |-
      (
        sum by (cluster, namespace, job, instance, rule_group) (prometheus_rule_group_last_duration_seconds{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"})
      >
        sum by (cluster, namespace, job, instance, rule_group) (prometheus_rule_group_interval_seconds{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"})
      )
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 386d20888c0984a7a5640e1627c3fb99
    severity: warning
  - alert: ThanosRuleGrpcErrorRate
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.job{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} is failing to handle {{`{{`}}$value | humanize{{`}}`}}% of requests.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulegrpcerrorrate
      summary: Thanos Rule is failing to handle grpc requests.
    expr: |-
      (
        sum by (cluster, namespace, job, instance) (rate(grpc_server_handled_total{grpc_code=~"Unknown|ResourceExhausted|Internal|Unavailable|DataLoss|DeadlineExceeded", job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      /
        sum by (cluster, namespace, job, instance) (rate(grpc_server_started_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      * 100 > 5
      )
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 6cefe8c838cd7b1b9fc8ac3a67e7fed6
    severity: warning
  - alert: ThanosRuleConfigReloadFailure
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.job{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has not been able to reload its configuration.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosruleconfigreloadfailure
      summary: Thanos Rule has not been able to reload configuration.
    expr: avg by (cluster, namespace, job, instance) (thanos_rule_config_last_reload_successful{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}) != 1
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 71de0adaceee2af75a09beb08a0062a2
    severity: info
  - alert: ThanosRuleQueryHighDNSFailures
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.job{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has {{`{{`}}$value | humanize{{`}}`}}% of failing DNS queries for query endpoints.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulequeryhighdnsfailures
      summary: Thanos Rule is having high number of DNS failures.
    expr: |-
      (
        sum by (cluster, namespace, job, instance) (rate(thanos_rule_query_apis_dns_failures_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      /
        sum by (cluster, namespace, job, instance) (rate(thanos_rule_query_apis_dns_lookups_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      * 100 > 1
      )
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 70d976940a6ee03ab86a658abf3a0c08
    severity: warning
  - alert: ThanosRuleAlertmanagerHighDNSFailures
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has {{`{{`}}$value | humanize{{`}}`}}% of failing DNS queries for Alertmanager endpoints.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulealertmanagerhighdnsfailures
      summary: Thanos Rule is having high number of DNS failures.
    expr: |-
      (
        sum by (cluster, namespace, job, instance) (rate(thanos_rule_alertmanagers_dns_failures_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      /
        sum by (cluster, namespace, job, instance) (rate(thanos_rule_alertmanagers_dns_lookups_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m]))
      * 100 > 1
      )
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 8cbe90cf6e5abac46fa60f29b9b3dc12
    severity: warning
  - alert: ThanosRuleNoEvaluationFor10Intervals
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.job{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} has {{`{{`}}$value | humanize{{`}}`}}% rule groups that did not evaluate for at least 10x of their expected interval.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosrulenoevaluationfor10intervals
      summary: Thanos Rule has rule groups that did not evaluate for 10 intervals.
    expr: |-
      time() -  max by (cluster, namespace, job, instance, group) (prometheus_rule_group_last_evaluation_timestamp_seconds{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"})
      >
      10 * max by (cluster, namespace, job, instance, group) (prometheus_rule_group_interval_seconds{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"})
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 96e6fa0bcbecd8b9c2720a168bb9ae68
    severity: info
  - alert: ThanosNoRuleEvaluations
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: Thanos Rule {{`{{`}}$labels.instance{{`}}`}} in {{`{{`}}$labels.namespace{{`}}`}} did not perform any rule evaluations in the past 10 minutes.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/thanos/thanosnoruleevaluations
      summary: Thanos Rule did not perform any rule evaluations.
    expr: |-
      sum by (cluster, namespace, job, instance) (rate(prometheus_rule_evaluations_total{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}[5m])) <= 0
        and
      sum by (cluster, namespace, job, instance) (thanos_rule_loaded_rules{job="thanos-ruler-kubesphere",namespace="{{ $namespace }}"}) > 0
    for: 5m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 8aa44c144c2a9504e9905d445136dcdb
    severity: critical
{{- end }}