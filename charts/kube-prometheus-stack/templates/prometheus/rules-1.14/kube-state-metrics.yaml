{{- /*
Generated from 'kube-state-metrics' group from https://raw.githubusercontent.com/WhizardTelemetry/kse-prometheus/kse/manifests/kube-state-metrics/kube-state-metrics-alertRuleGroups.yaml
Do not change in-place! In order to change this file first read following link:
https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack/hack
*/ -}}
{{- $kubeTargetVersion := default .Capabilities.KubeVersion.GitVersion .Values.kubeTargetVersionOverride }}
{{- if and (semverCompare ">=1.14.0-0" $kubeTargetVersion) (semverCompare "<9.9.9-9" $kubeTargetVersion) .Values.defaultRules.create .Values.defaultRules.rules.kubeStateMetrics }}
apiVersion: alerting.kubesphere.io/v2beta1
kind: GlobalRuleGroup
metadata:
  name: {{ printf "%s-%s" (include "kube-prometheus-stack.fullname" .) "kube-state-metrics" | trunc 63 | trimSuffix "-" }}
  labels:
    app: {{ template "kube-prometheus-stack.name" . }}
    alerting.kubesphere.io/builtin: "true"
    alerting.kubesphere.io/enable: "true"
{{- include "kube-prometheus-stack.labels" . | indent 4 }}
{{- if .Values.defaultRules.labels }}
{{ toYaml .Values.defaultRules.labels | indent 4 }}
{{- end }}
{{- if .Values.defaultRules.annotations }}
  annotations:
{{ toYaml .Values.defaultRules.annotations | indent 4 }}
{{- end }}
spec:
  rules:
  - alert: KubeStateMetricsListErrors
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: kube-state-metrics is experiencing errors at an elevated rate in list operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/kube-state-metrics/kubestatemetricslisterrors
      summary: kube-state-metrics is experiencing errors in list operations.
    expr: |-
      (sum by(cluster,namespace,service) (rate(kube_state_metrics_list_total{job="kube-state-metrics",result="error"}[5m]))
        /
      sum by(cluster,namespace,service) (rate(kube_state_metrics_list_total{job="kube-state-metrics"}[5m])))
      > 0.01
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 0e7897c5cfbca8933deedd7475be2e6f
    severity: critical
  - alert: KubeStateMetricsWatchErrors
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: kube-state-metrics is experiencing errors at an elevated rate in watch operations. This is likely causing it to not be able to expose metrics about Kubernetes objects correctly or at all.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/kube-state-metrics/kubestatemetricswatcherrors
      summary: kube-state-metrics is experiencing errors in watch operations.
    expr: |-
      (sum by(cluster,namespace,service) (rate(kube_state_metrics_watch_total{job="kube-state-metrics",result="error"}[5m]))
        /
      sum by(cluster,namespace,service) (rate(kube_state_metrics_watch_total{job="kube-state-metrics"}[5m])))
      > 0.01
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 152ccb43660a19968a830ae2050f1855
    severity: critical
  - alert: KubeStateMetricsShardingMismatch
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: kube-state-metrics pods are running with different --total-shards configuration, some Kubernetes objects may be exposed multiple times or not exposed at all.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/kube-state-metrics/kubestatemetricsshardingmismatch
      summary: kube-state-metrics sharding is misconfigured.
    expr: stdvar by(cluster,namespace,service) (kube_state_metrics_total_shards{job="kube-state-metrics"}) != 0
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: 1e8f579922412497e9b3d29c412b31fe
    severity: critical
  - alert: KubeStateMetricsShardsMissing
    annotations:
{{- if .Values.defaultRules.additionalRuleAnnotations }}
{{ toYaml .Values.defaultRules.additionalRuleAnnotations | indent 6 }}
{{- end }}
      description: kube-state-metrics shards are missing, some Kubernetes objects are not being exposed.
      runbook_url: {{ .Values.defaultRules.runbookUrl }}/kube-state-metrics/kubestatemetricsshardsmissing
      summary: kube-state-metrics shards are missing.
    expr: |-
      2^max by(cluster,namespace,service) (kube_state_metrics_total_shards{job="kube-state-metrics"}) - 1
        -
      sum by(cluster,namespace,service) ( 2 ^ max by (shard_ordinal,cluster,namespace,service) (kube_state_metrics_shard_ordinal{job="kube-state-metrics"}) )
      != 0
    for: 15m
    labels:
{{- if .Values.defaultRules.additionalRuleLabels }}
{{ toYaml .Values.defaultRules.additionalRuleLabels | indent 6 }}
{{- end }}
      rule_id: d859094c0a5ac6357cab4c776ccd5093
    severity: critical
{{- end }}